# CursorX 官网更新部署指南

## 📋 当前状态

✅ **已完成：**
- appcast.xml 文件已创建
- downloads/ 目录已创建
- 测试版本配置已添加

⏳ **待完成：**
- 生成签名密钥
- 上传安装包文件
- 配置签名
- 部署到 GitHub Pages

## 🚀 完整部署流程

### 第一步：准备安装包文件

#### 1.1 导出应用为 .dmg 文件

在 Xcode 中：

```bash
# 方法1：使用 Xcode Archive
1. Product → Archive
2. 等待归档完成
3. 点击 "Distribute App"
4. 选择 "Copy App"
5. 保存到本地

# 方法2：直接创建 DMG（推荐用于测试）
cd /Users/ymg/gitee/xcursor/xpoint
./create_dmg.sh  # 使用我们创建的脚本
```

#### 1.2 将 .dmg 文件复制到 downloads 目录

```bash
# 复制到官网 downloads 目录
cp /path/to/CursorX-1.0.0.dmg /Users/ymg/gitee/xcursor/xpoint/CursorX-portal/downloads/
```

### 第二步：生成并配置签名

#### 2.1 生成 EdDSA 密钥对

Sparkle 2.0+ 使用 EdDSA 签名。有两种方法：

**方法1：使用 Sparkle 工具（推荐）**

```bash
# 如果已安装 Sparkle
cd /Users/ymg/gitee/xcursor/xpoint
./generate_sparkle_keys.sh

# 或者手动下载 Sparkle
# 1. 访问 https://github.com/sparkle-project/Sparkle/releases
# 2. 下载最新版本
# 3. 解压后运行：
./bin/generate_keys
```

**方法2：使用 OpenSSL（备选）**

```bash
# 生成 EdDSA 密钥对
openssl genpkey -algorithm ed25519 -out eddsa_private_key.pem
openssl pkey -in eddsa_private_key.pem -pubout -out eddsa_public_key.pem

# 提取公钥（base64 格式）
openssl pkey -in eddsa_public_key.pem -pubin -outform DER | base64
```

#### 2.2 配置公钥

**在 appcast.xml 中添加公钥：**

```xml
<rss version="2.0" xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle">
    <channel>
        <title>CursorX 更新</title>
        <!-- 在这里添加公钥 -->
        <sparkle:publicKey>YOUR_BASE64_PUBLIC_KEY_HERE</sparkle:publicKey>
        
        <!-- 其他内容... -->
    </channel>
</rss>
```

**在应用的 Info.plist 中配置公钥：**

```xml
<key>SUPublicEDKey</key>
<string>YOUR_BASE64_PUBLIC_KEY_HERE</string>
```

#### 2.3 签名 .dmg 文件

```bash
# 使用 Sparkle 工具签名
./bin/sign_update /Users/ymg/gitee/xcursor/xpoint/CursorX-portal/downloads/CursorX-1.0.0.dmg eddsa_private_key.pem

# 输出示例：
# sparkle:edSignature="MC0CFQCdoW13VBGJWoj..."

# 将签名添加到 appcast.xml 的对应版本中
```

#### 2.4 更新 appcast.xml

```xml
<enclosure url="https://cursorx.app/downloads/CursorX-1.0.0.dmg"
           sparkle:version="1.0.0"
           sparkle:shortVersionString="1.0.0"
           length="13107200"
           type="application/octet-stream"
           sparkle:edSignature="MC0CFQCdoW13VBGJWoj..."/>  <!-- 替换为实际签名 -->
```

### 第三步：部署到 GitHub Pages

#### 3.1 提交更改

```bash
cd /Users/ymg/gitee/xcursor/xpoint/CursorX-portal

# 添加文件
git add appcast.xml
git add downloads/CursorX-1.0.0.dmg
git add downloads/README.md

# 提交
git commit -m "添加 CursorX v1.0.0 更新包和 appcast.xml"

# 推送到 GitHub
git push origin main  # 或 master，取决于您的主分支名称
```

#### 3.2 验证部署

等待 GitHub Pages 部署完成（通常 1-2 分钟），然后验证：

```bash
# 检查 appcast.xml 是否可访问
curl https://cursorx.app/appcast.xml

# 检查下载文件是否可访问
curl -I https://cursorx.app/downloads/CursorX-1.0.0.dmg
```

### 第四步：测试更新功能

#### 4.1 本地测试

```bash
# 启动应用
open /path/to/xpoint.app

# 点击状态栏 → 检查更新
# 应该能看到更新检查过程
```

#### 4.2 强制测试更新

**方法1：临时降低版本号**

在 `Info.plist` 中：
```xml
<key>CFBundleShortVersionString</key>
<string>0.9.0</string>  <!-- 临时改为低于 1.0.0 的版本 -->
```

**方法2：清除 Sparkle 缓存**

```bash
# 删除 Sparkle 缓存
defaults delete com.ymg.xpoint SULastCheckTime
defaults delete com.ymg.xpoint SUSkippedVersion

# 重启应用
killall xpoint
open /path/to/xpoint.app
```

## 🔧 简化方案（无签名测试）

如果您想先测试更新流程，可以暂时跳过签名：

### 1. 修改 appcast.xml

```xml
<!-- 移除 sparkle:edSignature 属性 -->
<enclosure url="https://cursorx.app/downloads/CursorX-1.0.0.dmg"
           sparkle:version="1.0.0"
           sparkle:shortVersionString="1.0.0"
           length="13107200"
           type="application/octet-stream"/>
```

### 2. 修改 Info.plist

```xml
<!-- 移除或注释掉公钥配置 -->
<!-- <key>SUPublicEDKey</key> -->
<!-- <string>WILL_BE_GENERATED</string> -->
```

### 3. 禁用签名验证（仅用于测试）

在 `UpdateManager.swift` 的 `setupSparkle()` 中添加：

```swift
// ⚠️ 仅用于测试，生产环境必须移除
updater.sendsSystemProfile = false
```

**⚠️ 注意：** 这种方式仅用于测试，生产环境必须配置签名！

## 📦 自动化脚本

我已经为您创建了自动化脚本，让部署更简单：

### 使用方法：

```bash
# 1. 创建 DMG
cd /Users/ymg/gitee/xcursor/xpoint
./create_dmg.sh

# 2. 部署到官网
cd CursorX-portal
./deploy_update.sh 1.0.0
```

## 🎯 快速检查清单

部署前请确认：

- [ ] ✅ appcast.xml 文件已创建
- [ ] ✅ downloads/ 目录已创建
- [ ] ⏳ .dmg 文件已准备好
- [ ] ⏳ EdDSA 密钥已生成
- [ ] ⏳ 公钥已配置到 appcast.xml
- [ ] ⏳ 公钥已配置到 Info.plist
- [ ] ⏳ .dmg 文件已签名
- [ ] ⏳ 签名已添加到 appcast.xml
- [ ] ⏳ 文件已上传到 GitHub
- [ ] ⏳ GitHub Pages 已部署
- [ ] ⏳ URL 可访问性已验证
- [ ] ⏳ 更新功能已测试

## 🆘 常见问题

### Q1: 如何获取 .dmg 文件大小？

```bash
ls -l /path/to/CursorX-1.0.0.dmg | awk '{print $5}'
```

### Q2: 如何验证签名是否正确？

```bash
# 使用 Sparkle 工具验证
./bin/verify_signature /path/to/CursorX-1.0.0.dmg eddsa_public_key.pem SIGNATURE
```

### Q3: GitHub Pages 部署后多久生效？

通常 1-2 分钟，可以在仓库的 Actions 标签查看部署状态。

### Q4: 如何调试更新检查失败？

```bash
# 查看应用日志
log stream --predicate 'process == "xpoint"' --level debug | grep Update

# 查看 Sparkle 日志
defaults read com.ymg.xpoint
```

## 📞 下一步

完成官网部署后，您可以：

1. 测试完整的更新流程
2. 配置自动更新策略
3. 添加更新通知
4. 优化用户体验

---

**重要提醒：**
- 私钥文件（`eddsa_private_key.pem`）请妥善保管，不要提交到 Git
- 建议将私钥备份到安全的地方
- 生产环境必须配置签名验证
